<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <!--
                             :i                         
     ;@s,                  ,22Xhr                  .s#  
     S:.22;,            ,;2S.   i9i:            .;i5:A  
     S,   ;iSirr;::;rsSsr,        ,r5SSsrr;;ri5XSs.  2  
     i,       .,::::,.                .,;;;;;:       r  
     5:                                              h. 
     i,                                              G. 
     X.              .r                              h. 
     X,               @,                             2. 
     5:               ;M                             9. 
     i,                &r                            h. 
     3.                .#                            h. 
     h                  XX                           9. 
     &                S@@Ss@@@h                      9. 
     H                 2A : @s,                      9. 
     2                rs,r;:Ss                       G, 
     S                :r,@   #.                      h, 
     9                   X:  r#,                     X. 
     &                   H    :52S;.                 5, 
     9                  :#       :ih3XS;.            S: 
     G                  ;#            :2@@r          s  
     3:                  3G,r: &         @           X  
     :X                   9A@;r@92; s,   @          :S  
      A:                  ,X#.A  ;2H@@  #:          &   
      .B                  X@ @5     @Ms:A          2r   
       ,H                 ;# @s     2h@XX         is    
        :A:             .,#@ @M2M@AX&sA,X        S;     
          Bi         2BH3i;:;:;993@@@#5r.      :9,      
           rhr      #@. ;;     ;r:,#@@@@     ,2S        
             sSr 5#A;   ,:  .i#S#;, H@@@@s :XS.         
               ;i&i       ,r; , 5H@&;@X,hGSr            
                  ,rir:,.         .,.,..                
                     .,;rsrsirrr;;.                     
    -->
    <title>mesh static</title>

    <script src="3js/three.min.js"></script>
    <script src="3js/OrbitControls.js"></script>
    <script src="3js/STLLoader.js"></script>

    <script>

      var gScene, gCamera, gRenderer, gControls;
      var gParticles;
      var gWidth  = 400;
      var gHeight = 400;

      var gNumPoints = 1000;
 

      function gebid(id) {
        return document.getElementById(id);
      }

      function onLoad() {
        init();
        animate();
      }

      function init() {
        gScene  = new THREE.Scene();

        gRenderer = new THREE.WebGLRenderer({antialias:true});
        gRenderer.setSize(gWidth, gHeight);
        gebid('webgl_container').appendChild(gRenderer.domElement);

        gCamera = new THREE.PerspectiveCamera(45, gWidth / gHeight, 0.1, 100);
        gCamera.position.set(0, 0, 5);
        gScene.add(gCamera);

        var light = new THREE.PointLight(0x888855);
        light.position.set(-50,-50,100);
        gScene.add(light);

        var light = new THREE.PointLight(0x558888);
        light.position.set(50,50,-100);
        gScene.add(light);

        var light = new THREE.PointLight(0x885588);
        light.position.set(50,100,-50);
        gScene.add(light);

        var loader = new THREE.STLLoader();
        loader.load( 'models/reef_110.stl', function ( geometry ) {
          var material = new THREE.MeshLambertMaterial();
          gScene.add( new THREE.Mesh( geometry, material ) );
          thinkTriangles(geometry);
          doIt();
        });

        gParticles = new THREE.Geometry();
        var pMaterial = new THREE.PointsMaterial({
          color: 0xFFFFFF,
          size: 0.05,
          // map: THREE.TextureLoader(
          //   "images/dot_128.png"
          // ),
          blending: THREE.AdditiveBlending,
          transparent: true
        });

        var particleSystem = new THREE.Points(
          gParticles,
          pMaterial);

        for (var n = 0; n < gNumPoints; ++n) {
         var particle = new THREE.Vector3(10, 10, 10);
         var particle = new THREE.Vector3(0, 0, 0);
          gParticles.vertices.push(particle);
        }

        gScene.add(particleSystem);

        gControls = new THREE.OrbitControls(gCamera, gRenderer.domElement);
        // gControls.enableDamping = true;
        // gControls.dampingFactor = 0.25;
      }

      function animate() {
        requestAnimationFrame(animate);
        gRenderer.render(gScene, gCamera);
        gControls.update();
      }

      function dist(ptA, ptB) {
        var dx = ptB.x - ptA.x;
        var dy = ptB.y - ptA.y;
        var dz = ptB.z - ptA.z;
        return Math.sqrt((dx * dx) + (dy * dy) + (dz * dz));
      }

      var gCumulativeAreas = [];
      var gTriangles;

      function thinkTriangles(geometry) {
        gTriangles = geometry;

        var verts = geometry.vertices;

        var totalArea = 0;

        var num = geometry.faces.length;
        for (var n = 0; n < num; ++n) {
          var face = geometry.faces[n];
          // heron's formula for area
          var ab = dist(verts[face.a], verts[face.b]);
          var bc = dist(verts[face.b], verts[face.c]);
          var ca = dist(verts[face.c], verts[face.a]);
          var s = (ab + bc + ca) / 2;
          var A = Math.sqrt(s * (s - ab) * (s - bc) * (s - ca));
          totalArea += A;
          gCumulativeAreas[n] = totalArea;
        }
      }

      function chooseTriangle() {
        var totalArea = gCumulativeAreas[gCumulativeAreas.length - 1];
        var r = Math.random() * totalArea;
        var chosen = gCumulativeAreas.length - 1;
        for (var n = 0; n <= chosen; ++n) {
          if (gCumulativeAreas[n] > r) {
            chosen = n;
            break;
          }
        }

        return chosen;
      }

      function doIt() {
        var verts = gTriangles.vertices;

        for (n = 0; n < gNumPoints; ++n) {        
          var triIndex = chooseTriangle();

          var face = gTriangles.faces[triIndex];

          var x = (verts[face.a].x + verts[face.b].x + verts[face.c].x) / 3;
          var y = (verts[face.a].y + verts[face.b].y + verts[face.c].y) / 3;
          var z = (verts[face.a].z + verts[face.b].z + verts[face.c].z) / 3;

          gParticles.vertices[n].x = x;
          gParticles.vertices[n].y = y;
          gParticles.vertices[n].z = z;
        }

        gParticles.verticesNeedUpdate = true;
      }

      function onClickNew() {
        doIt();
      }

    </script>
  </head>
  <style>
    body {
      font-family: Courier New, monospace;
      background-color: DarkSlateGray;
      color:MistyRose;
    }
    canvas {
      border: 1px solid #bbb;
    }

    #webgl_container {
      display:inline-block;
    }
  </style>

  <body onload="onLoad()">
    <div id="webgl_container" width=400px height=400px></div><br>
    <button onClick="onClickNew()">new</button>
  </body>
</html>